<?xml version="1.0" encoding="utf-8" ?>
<page:BasePage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
               xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
               xmlns:page="clr-namespace:EcoPlatesMobile.Views"
               xmlns:component="clr-namespace:EcoPlatesMobile.Views.Components"
               xmlns:view="clr-namespace:EcoPlatesMobile.Views.Components"
               x:Class="EcoPlatesMobile.Views.AnnouncementsPage"
               BackgroundColor="{AppThemeBinding Light=#F6F7FB, Dark=#121212}">

    <Grid RowDefinitions="Auto,*">

        <!-- Header -->
        <component:CustomHeader x:Name="header"
                                Title="Announcements"/>

        <!-- Content -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}">

            <Grid Padding="16,12">

                <CollectionView ItemsSource="{Binding Announcements}"
                                ItemsUpdatingScrollMode="KeepScrollOffset"
                                SelectionMode="None"
                                ItemsLayout="VerticalList"
                                RemainingItemsThreshold="4"
                                RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}">

                    <!-- Empty state -->
                    <CollectionView.EmptyView>
                         <ContentView>
                            <ContentView.Triggers>
                                <DataTrigger TargetType="ContentView"
                                            Binding="{Binding IsLoading}"
                                            Value="True">
                                    <Setter Property="IsVisible" Value="False" />
                                </DataTrigger>
                                <DataTrigger TargetType="ContentView"
                                            Binding="{Binding IsRefreshing}"
                                            Value="True">
                                    <Setter Property="IsVisible" Value="False" />
                                </DataTrigger>
                            </ContentView.Triggers>
                            <view:EmptyViewText/>
                        </ContentView>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Margin="0,0,0,12"
                                   Padding="14"
                                   CornerRadius="16"
                                   HasShadow="True"
                                   BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}">

                                <!-- Tap on whole card -->
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="Announcement_Tapped"
                                                          NumberOfTapsRequired="1"
                                                          CommandParameter="{Binding .}"/>
                                </Frame.GestureRecognizers>

                                <Grid ColumnDefinitions="Auto,*"
                                      RowDefinitions="Auto,Auto"
                                      ColumnSpacing="12"
                                      RowSpacing="6">

                                    <!-- Unread dot -->
                                    <Grid WidthRequest="10" 
                                          HeightRequest="10"
                                          VerticalOptions="Start"
                                          Margin="2,6,0,0">
                                        <Ellipse Fill="#2563EB"
                                                 IsVisible="{Binding IsUnread}"/>
                                    </Grid>

                                    <VerticalStackLayout Grid.Column="1" Spacing="4">
                                        <Label Text="{Binding Title}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               LineBreakMode="TailTruncation"
                                               TextColor="{AppThemeBinding Light=#111827, Dark=#F3F4F6}" />

                                        <Label Text="{Binding Preview}"
                                               FontSize="13"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="2"
                                               TextColor="{AppThemeBinding Light=#4B5563, Dark=#C7C7C7}" />

                                        <Label Text="{Binding CreatedAtText}"
                                               FontSize="12"
                                               TextColor="{AppThemeBinding Light=#9CA3AF, Dark=#9CA3AF}" />
                                    </VerticalStackLayout>

                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                </CollectionView>

            </Grid>
        </RefreshView>
 
        <ActivityIndicator x:Name="loading" 
                           IsRunning="{Binding IsLoading}"
                           Color="{StaticResource User}"
                           Scale="1.5"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"
                           Grid.Row="1"/>

        <!-- ================= Bottom Sheet Overlay (FIXED) ================= -->
        <Grid x:Name="SheetOverlay"
              Grid.Row="0"
              Grid.RowSpan="2"
              IsVisible="False"
              Opacity="0">

            <!-- Dim background -->
            <BoxView BackgroundColor="#80000000">
                <BoxView.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnBackdropTapped" />
                </BoxView.GestureRecognizers>
            </BoxView>

            <!-- Bottom Sheet -->
            <Frame x:Name="BottomSheet"
                   VerticalOptions="End"
                   Margin="12,0,12,12"
                   Padding="18,14"
                   CornerRadius="22"
                   HasShadow="True"
                   BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   HeightRequest="{Binding SheetHeight}"
                   TranslationY="{Binding SheetHeight}">

                <Grid RowDefinitions="Auto,Auto,*"
                      RowSpacing="10">

                    <!-- Top bar: title + close -->
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Text="{Binding SelectedAnnouncement.Title}"
                               FontSize="16"
                               FontAttributes="Bold"
                               LineBreakMode="TailTruncation"
                               TextColor="{AppThemeBinding Light=#111827, Dark=#F3F4F6}" />

                        <Label Grid.Column="1"
                               Text="âœ•"
                               FontSize="22"
                               VerticalOptions="Center"
                               HorizontalOptions="End">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnCloseSheetClicked" />
                            </Label.GestureRecognizers>
                        </Label>
                    </Grid>

                    <Label Grid.Row="1"
                           Text="{Binding SelectedAnnouncement.CreatedAtText}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#9CA3AF, Dark=#9CA3AF}" />

                    <!-- Body scroll -->
                    <ScrollView Grid.Row="2">
                        <Label Text="{Binding SelectedAnnouncement.Body}"
                               FontSize="14"
                               LineHeight="1.4"
                               TextColor="{AppThemeBinding Light=#374151, Dark=#E5E7EB}" />
                    </ScrollView>

                </Grid>
            </Frame>

        </Grid>
        
    </Grid>
</page:BasePage>