<?xml version="1.0" encoding="utf-8" ?>
<page:BasePage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
               xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
               xmlns:page="clr-namespace:EcoPlatesMobile.Views"
               xmlns:component="clr-namespace:EcoPlatesMobile.Views.Components"
               xmlns:view="clr-namespace:EcoPlatesMobile.Views.Components"
               xmlns:language="clr-namespace:EcoPlatesMobile.Resources.Languages"
               x:Class="EcoPlatesMobile.Views.AnnouncementsPage"
               BackgroundColor="White">

    <Grid RowDefinitions="Auto,*">

        <!-- Header -->
        <component:CustomHeader x:Name="header"
                                Title="{x:Static language:AppResource.Announcements}"/>

        <!-- Content -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}">

            <Grid Padding="16,12">

                <CollectionView ItemsSource="{Binding Announcements}"
                                ItemsUpdatingScrollMode="KeepScrollOffset"
                                SelectionMode="None"
                                RemainingItemsThreshold="4"
                                RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}">

                    <!-- Empty state -->
                    <CollectionView.EmptyView>
                         <ContentView>
                            <ContentView.Triggers>
                                <DataTrigger TargetType="ContentView"
                                            Binding="{Binding IsLoading}"
                                            Value="True">
                                    <Setter Property="IsVisible" Value="False" />
                                </DataTrigger>
                                <DataTrigger TargetType="ContentView"
                                            Binding="{Binding IsRefreshing}"
                                            Value="True">
                                    <Setter Property="IsVisible" Value="False" />
                                </DataTrigger>
                            </ContentView.Triggers>
                            <view:EmptyViewText/>
                        </ContentView>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical" 
                                         VerticalItemSpacing="20"
                                         HorizontalItemSpacing="10"/>
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Margin="0,0,0,12"
                                   Padding="14"
                                   CornerRadius="17"
                                   BorderColor="Gray"
                                   HasShadow="false"
                                   BackgroundColor="White">

                                <!-- Tap on whole card -->
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="Announcement_Tapped"
                                                          NumberOfTapsRequired="1"
                                                          CommandParameter="{Binding .}"/>
                                </Frame.GestureRecognizers>

                                <Grid ColumnDefinitions="Auto,*"
                                      RowDefinitions="Auto,Auto"
                                      ColumnSpacing="12"
                                      RowSpacing="6">

                                    <!-- Unread dot -->
                                    <Grid WidthRequest="10" 
                                          HeightRequest="10"
                                          VerticalOptions="Start"
                                          Margin="2,6,0,0">
                                        <Ellipse Fill="#2563EB"
                                                 IsVisible="{Binding IsUnread}"/>
                                    </Grid>

                                    <VerticalStackLayout Grid.Column="1" Spacing="4">
                                        <Label Text="{Binding Title}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               LineBreakMode="TailTruncation"
                                               TextColor="Black" />

                                        <Label Text="{Binding Preview}"
                                               FontSize="13"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="2"
                                               TextColor="Black" />

                                        <Label Text="{Binding CreatedAtText}"
                                               FontSize="12"
                                               TextColor="Gray" />
                                    </VerticalStackLayout>

                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                </CollectionView>

            </Grid>
        </RefreshView>
 
        <ActivityIndicator x:Name="loading"
                           IsRunning="{Binding IsLoading}"
                           Color="{StaticResource User}"
                           Scale="1.5"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"
                           Grid.Row="1"/>

        <!-- Dim background 
        <BoxView x:Name="boxBackground"
                    Opacity="0"
                    IsVisible="True"
                    BackgroundColor="Black"
                    InputTransparent="True"
                    Grid.Row="0"
                    Grid.RowSpan="2"/>-->

        <!-- ================= Bottom Sheet Overlay (FIXED) ================= -->
        <Grid x:Name="SheetOverlay"
              IsVisible="False"
              Opacity="0"
              Grid.Row="0"
              Grid.RowSpan="2">

            <!-- Backdrop -->
            <BoxView x:Name="Backdrop"
                    BackgroundColor="Black"
                    Opacity="0.5">
                <BoxView.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnBackdropTapped" NumberOfTapsRequired="1" />
                </BoxView.GestureRecognizers>
            </BoxView>

            <!-- Bottom Sheet -->
            <Frame x:Name="BottomSheet"
                   VerticalOptions="End"
                   Margin="12,0,12,12"
                   Padding="18,14"
                   CornerRadius="22"
                   BorderColor="Gray"
                   HasShadow="False"
                   BackgroundColor="white"
                   HeightRequest="{Binding SheetHeight}"
                   TranslationY="{Binding SheetHeight}">

                <Grid x:Name="SheetDragArea" 
                      RowDefinitions="Auto,Auto,*"
                      RowSpacing="10">

                    <Grid.GestureRecognizers>
                        <PanGestureRecognizer PanUpdated="OnSheetPanUpdated" />
                    </Grid.GestureRecognizers>

                    <!-- Top bar: title + close -->
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Text="{Binding SelectedAnnouncement.Title}"
                               FontSize="16"
                               FontAttributes="Bold"
                               LineBreakMode="TailTruncation"
                               TextColor="Black"/>

                        <Label Grid.Column="1"
                               Text="âœ•"
                               FontSize="22"
                               VerticalOptions="Center"
                               HorizontalOptions="End">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnCloseSheetClicked" />
                            </Label.GestureRecognizers>
                        </Label>
                    </Grid>

                    <Label Grid.Row="1"
                           Text="{Binding SelectedAnnouncement.CreatedAtText}"
                           FontSize="12"
                           TextColor="Black" />

                    <!-- Body scroll -->
                    <ScrollView Grid.Row="2">
                        <Label Text="{Binding SelectedAnnouncement.Body}"
                               FontSize="14"
                               LineHeight="1.4"
                               TextColor="Black" />
                    </ScrollView>

                </Grid>
            </Frame>

        </Grid>
        
    </Grid>
</page:BasePage>